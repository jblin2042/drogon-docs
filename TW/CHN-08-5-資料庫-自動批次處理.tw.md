[English](/ENG/ENG-08-5-Database-auto_batch)

# 資料庫 - 自動批次處理

自動批次處理模式僅適用於 PostgreSQL 14+ 版本的客戶端程式庫，其他情況會被忽略。介紹自動批次處理前，先說明 pipeline 模式。

## pipeline 模式

自 PostgreSQL 14 起，客戶端程式庫支援 pipelining 模式，該模式下新 SQL 請求可直接送至伺服器端，無需等待上一個請求結果（類似 HTTP pipelining 概念），詳見 [Pipeline mode](https://www.postgresql.org/docs/current/libpq-pipeline-mode.html)。此模式大幅提升效能，少量連線即可支援大量併發請求。
drogon 自 1.7.6 版起支援此功能，會自動檢查 libpq 是否支援 pipeline，若支援則所有 DbClient 請求皆採 pipeline 模式。

## 自動批次處理

預設下，非交易型 DbClient 每個 SQL 請求都建立同步點（隱式交易），確保 SQL 彼此獨立，故 pipeline 與非 pipeline 對使用者而言等價。

但每條 SQL 建立同步點有較大效能開銷，drogon 因此提供自動批次處理模式，此模式下同步點不再每條 SQL 都建立，而是多條 SQL 後才建立。規則如下：

* 每個 EventLoop 迴圈的最後一條 SQL 必定建立同步點；
* 寫入資料庫的 SQL 後建立同步點；
* 長 SQL 後建立同步點；
* 同一同步點後連續 SQL 數達上限時建立同步點；

注意，同一連線兩個同步點間的 SQL 屬同一隱式交易，drogon 未提供顯式開關同步點介面，這些 SQL 在邏輯上可能無關，但因同屬一交易，會互相影響。此模式並非完全安全，問題如下：

* 一條失敗 SQL 會導致自上個同步點後至該 SQL 的所有語句回滾，且使用者不會收到通知（因未用顯式交易）；
* 一條失敗 SQL 會導致其後至下個同步點前的所有 SQL 都回傳失敗；
* 判斷寫入 SQL 只靠關鍵字（如 insert, update），無法涵蓋所有情況（如 select 呼叫儲存程序），故 drogon 雖盡力減少負面影響，但非絕對安全；

因此，自動批次處理模式雖有效能提升，但安全性不足，請依需求選用，例如純讀取 SQL 可用自動批次處理 DbClient。

> **注意** 即使純讀取 SQL 也可能導致交易失敗（如 select 超時），後續 SQL 也會受影響而失敗（可能不符應用邏輯），故自動批次處理僅適用於只讀且非關鍵查詢。建議另建自動批次處理 DbClient 專供此類 SQL 使用。由自動批次處理 DbClient 產生的交易物件則可放心使用。

## 啟用自動批次處理

使用 newPgClient 介面建立客戶端時，第三個參數設為 true 即啟用自動批次處理；
用設定檔建立客戶端時，auto_batch 選項設為 true 即啟用。

# 下一步：[參考資料 - 請求](/CHN/CHN-09-0-参考资料-请求)
